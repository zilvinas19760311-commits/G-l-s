<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gƒóli≈≥ lojalumo kortelƒó</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    .wrap{max-width:560px;margin:0 auto;padding:18px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:16px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    h1{font-size:22px;margin:0 0 8px}
    .sub{color:#666;margin:0 0 14px}
    .row{display:flex;justify-content:space-between;align-items:center;margin:12px 0}
    .pill{background:#f2f2f2;border-radius:999px;padding:6px 10px;font-weight:700}
    .stamps{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:14px 0}
    .stamp{height:54px;border-radius:12px;border:2px dashed #ddd;display:flex;align-items:center;justify-content:center;font-size:20px}
    .stamp.on{border-style:solid;border-color:#111}
    .btn{width:100%;border:0;border-radius:12px;padding:14px;font-size:16px;font-weight:800;cursor:pointer}
    .btn.primary{background:#111;color:#fff}
    input{width:100%;padding:14px;border-radius:12px;border:1px solid #ddd;margin-top:10px}
    .small{font-size:12px;color:#777;margin-top:8px}
    .ok{color:green;font-weight:700}
    .err{color:red;font-weight:700}
    hr{border:0;border-top:1px solid #eee;margin:16px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Gƒóli≈≥ lojalumo kortelƒó üå∏</h1>
    <p class="sub" id="sub">Kaupk apsilankymus ir gauk dovanƒÖ.</p>

    <div class="row">
      <div class="pill" id="progress">0 / 5</div>
      <div class="pill" id="reward">6-as: -50%</div>
    </div>

    <div class="stamps" id="stamps"></div>

    <hr>

    <div>
      <div class="small"><b>Telefono numeris (neb≈´tina)</b></div>
      <input id="phone" placeholder="+3706xxxxxxx" inputmode="tel" autocomplete="tel">
      <button class="btn primary" id="savePhone">I≈°saugoti</button>
      <div id="msg" class="small"></div>
    </div>

    <div id="staff" style="display:none;">
      <hr>
      <div class="small"><b>Pardavƒójo re≈æimas</b></div>
      <input id="pin" placeholder="PIN" inputmode="numeric" autocomplete="one-time-code">
      <button class="btn primary" id="add">+ Pridƒóti 1 apsilankymƒÖ</button>
      <div id="staffMsg" class="small"></div>
    </div>

  </div>
</div>

<script>
/* ============================= */
/* ƒÆRA≈†YK SAVO DUOMENIS ƒåIA     */
/* ============================= */

const SUPABASE_URL = "https://omxevzobieebtfuxgrak.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_3c2dqCHnIQVCjPDhWsOwDw_MeHKgJHB";

const FN_GET_OR_CREATE = "https://omxevzobieebtfuxgrak.supabase.co/functions/v1/get_or_create_card";
const FN_ADD_STAMP     = "https://omxevzobieebtfuxgrak.supabase.co/functions/v1/add_stamp";

/* ============================= */

const params = new URLSearchParams(location.search);
const SHOP = (params.get("shop") || "geles").toLowerCase();
const STAFF = params.get("staff") === "1";

const stampsEl = document.getElementById("stamps");
const progressEl = document.getElementById("progress");
const subEl = document.getElementById("sub");
const rewardEl = document.getElementById("reward");
const msgEl = document.getElementById("msg");
const staffBox = document.getElementById("staff");
const staffMsgEl = document.getElementById("staffMsg");

let cardId = null;
let target = 5;
let rewardText = "6-as: -50%";

if (STAFF) staffBox.style.display = "block";

function render(stamps){
  stampsEl.innerHTML = "";
  for(let i=1;i<=target;i++){
    const d = document.createElement("div");
    d.className = "stamp" + (i <= stamps ? " on" : "");
    d.innerText = i <= stamps ? "‚úì" : "";
    stampsEl.appendChild(d);
  }
  progressEl.innerText = stamps + " / " + target;
  rewardEl.innerText = rewardText;

  if(stamps >= target){
    subEl.innerText = "üéâ Dovana paruo≈°ta!";
  } else {
    subEl.innerText = "Kaupk apsilankymus ir gauk dovanƒÖ.";
  }
}

function normPhone(raw){
  const v = (raw || "").trim();
  if(!v) return null;
  // labai paprasta normalizacija: paliekam + ir skaiƒçius
  const cleaned = v.replace(/[^\d+]/g,"");
  return cleaned || null;
}

async function api(url, body){
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY
    },
    body: JSON.stringify(body)
  });

  const text = await res.text();

  if(!res.ok){
    throw new Error(res.status + " " + res.statusText + " | " + text);
  }

  try {
    return JSON.parse(text);
  } catch {
    throw new Error("Ne JSON atsakymas: " + text);
  }
}

async function load(phone){
  const data = await api(FN_GET_OR_CREATE, {
    shop: SHOP,
    phone: phone,
    target: 5,
    reward: rewardText
  });

  if(!data || !data.card) throw new Error("Nƒóra kortelƒós atsakyme");

  cardId = data.card.id;
  target = data.card.target ?? 5;

  render(Number(data.card.stamps || 0));
}

document.getElementById("savePhone").onclick = async () => {
  msgEl.innerHTML = "";
  const phone = normPhone(document.getElementById("phone").value);

  try{
    await load(phone);
    msgEl.innerHTML = "<span class='ok'>I≈°saugota</span>";
  }catch(e){
    msgEl.innerHTML = "<span class='err'>Klaida: " + (e?.message || e) + "</span>";
  }
};

document.getElementById("add").onclick = async () => {
  staffMsgEl.innerHTML = "";
  const pin = (document.getElementById("pin").value || "").trim();

  if(!cardId){
    staffMsgEl.innerHTML = "<span class='err'>Pirma sukurk kortelƒô (ƒØvesk tel. arba palik tu≈°ƒçiƒÖ ir spausk ‚ÄûI≈°saugoti‚Äú)</span>";
    return;
  }
  if(!pin){
    staffMsgEl.innerHTML = "<span class='err'>ƒÆvesk PIN</span>";
    return;
  }

  try{
    const data = await api(FN_ADD_STAMP, { card_id: cardId, pin });
    if(!data || !data.card) throw new Error("Nƒóra kortelƒós atsakyme");
    render(Number(data.card.stamps || 0));
    staffMsgEl.innerHTML = "<span class='ok'>Pridƒóta</span>";
  }catch(e){
    staffMsgEl.innerHTML = "<span class='err'>Klaida: " + (e?.message || e) + "</span>";
  }
};

// u≈ækraunam UI i≈° karto (be telefono)
load(null).catch(()=>{ render(0); });
</script>
</body>
</html>
