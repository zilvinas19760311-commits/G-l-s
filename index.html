<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GÄ—liÅ³ lojalumo kortelÄ—</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    .wrap{max-width:560px;margin:0 auto;padding:18px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:16px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    h1{font-size:22px;margin:0 0 8px}
    .sub{color:#666;margin:0 0 14px}
    .row{display:flex;justify-content:space-between;align-items:center;margin:12px 0}
    .pill{background:#f2f2f2;border-radius:999px;padding:6px 10px;font-weight:700}
    .stamps{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:14px 0}
    .stamp{height:54px;border-radius:12px;border:2px dashed #ddd;display:flex;align-items:center;justify-content:center;font-size:20px}
    .stamp.on{border-style:solid;border-color:#111}
    .btn{width:100%;border:0;border-radius:12px;padding:14px;font-size:16px;font-weight:800;cursor:pointer}
    .btn.primary{background:#111;color:#fff}
    input{width:100%;padding:14px;border-radius:12px;border:1px solid #ddd;margin-top:10px}
    .small{font-size:12px;color:#777;margin-top:8px}
    .ok{color:green;font-weight:700}
    .err{color:red;font-weight:700}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>GÄ—liÅ³ lojalumo kortelÄ— ðŸŒ¸</h1>
    <p class="sub" id="sub">Kaupk apsilankymus ir gauk dovanÄ….</p>

    <div class="row">
      <div class="pill" id="progress">0 / 5</div>
      <div class="pill">6-as: -50%</div>
    </div>

    <div class="stamps" id="stamps"></div>

    <hr>

    <div>
      <div class="small"><b>Telefono numeris (nebÅ«tina)</b></div>
      <input id="phone" placeholder="+3706xxxxxxx">
      <button class="btn primary" id="savePhone">IÅ¡saugoti</button>
      <div id="msg" class="small"></div>
    </div>

    <div id="staff" style="display:none;">
      <hr>
      <div class="small"><b>PardavÄ—jo reÅ¾imas</b></div>
      <input id="pin" placeholder="PIN">
      <button class="btn primary" id="add">+ PridÄ—ti 1 apsilankymÄ…</button>
      <div id="staffMsg" class="small"></div>
    </div>

  </div>
</div>

<script>
/* ============================= */
/* Ä®RAÅ YK SAVO DUOMENIS ÄŒIA     */
/* ============================= */

const SUPABASE_URL = "https://omxevzobieebtfuxgrak.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_3c2dqCHnIQVCjPDhWsOwDw_MeHKgJHB";

const FN_GET_OR_CREATE = "https://omxevzobieebtfuxgrak.supabase.co/functions/v1/get_or_create_card";
const FN_ADD_STAMP = "https://omxevzobieebtfuxgrak.supabase.co/functions/v1/add_stamp";

/* ============================= */

const params = new URLSearchParams(location.search);
const SHOP = params.get("shop") || "geles";
const STAFF = params.get("staff") === "1";

if(STAFF){
  document.getElementById("staff").style.display = "block";
}

const stampsEl = document.getElementById("stamps");
const progressEl = document.getElementById("progress");
const subEl = document.getElementById("sub");

let cardId = null;
let target = 5;

function render(stamps){
  stampsEl.innerHTML = "";
  for(let i=1;i<=target;i++){
    const d = document.createElement("div");
    d.className = "stamp" + (i <= stamps ? " on" : "");
    d.innerText = i <= stamps ? "âœ“" : "";
    stampsEl.appendChild(d);
  }
  progressEl.innerText = stamps + " / " + target;
  if(stamps >= target){
    subEl.innerText = "ðŸŽ‰ Dovana paruoÅ¡ta!";
  }
}

async function api(url, body){
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  });
  return res.json();
}

async function load(phone){
  const data = await api(FN_GET_OR_CREATE,{
    shop: SHOP,
    phone: phone || null,
    target: 5,
    reward: "6-as: -50%"
  });
  cardId = data.card.id;
  render(data.card.stamps);
}

document.getElementById("savePhone").onclick = async () => {
  const phone = document.getElementById("phone").value.trim();
  const msg = document.getElementById("msg");
  try{
    await load(phone || null);
    msg.innerHTML = "<span class='ok'>IÅ¡saugota</span>";
  }catch(e){
    msg.innerHTML = "<span class='err'>Klaida</span>";
  }
};

document.getElementById("add").onclick = async () => {
  const pin = document.getElementById("pin").value.trim();
  const staffMsg = document.getElementById("staffMsg");
  if(!cardId){
    staffMsg.innerHTML = "<span class='err'>NÄ—ra kortelÄ—s</span>";
    return;
  }
  const data = await api(FN_ADD_STAMP,{
    card_id: cardId,
    pin: pin
  });
  render(data.card.stamps);
  staffMsg.innerHTML = "<span class='ok'>PridÄ—ta</span>";
};

load(null);
</script>
</body>
</html>
