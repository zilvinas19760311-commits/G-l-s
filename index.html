<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gƒóli≈≥ lojalumo kortelƒó</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    .wrap{max-width:560px;margin:0 auto;padding:18px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:16px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    h1{font-size:22px;margin:0 0 8px}
    .sub{color:#666;margin:0 0 14px}
    .row{display:flex;justify-content:space-between;align-items:center;margin:12px 0}
    .pill{background:#f2f2f2;border-radius:999px;padding:6px 10px;font-weight:700}
    .stamps{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:14px 0}
    .stamp{height:54px;border-radius:12px;border:2px dashed #ddd;display:flex;align-items:center;justify-content:center;font-size:20px}
    .stamp.on{border-style:solid;border-color:#111}
    .btn{width:100%;border:0;border-radius:12px;padding:14px;font-size:16px;font-weight:800;cursor:pointer}
    .btn.primary{background:#111;color:#fff}
    input{width:100%;padding:14px;border-radius:12px;border:1px solid #ddd;margin-top:10px}
    .small{font-size:12px;color:#777;margin-top:8px}
    .ok{color:green;font-weight:700}
    .err{color:red;font-weight:700}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="title">Gƒóli≈≥ lojalumo kortelƒó üå∏</h1>
    <p class="sub" id="sub">Kaupk apsilankymus ir gauk dovanƒÖ.</p>

    <div class="row">
      <div class="pill" id="progress">0 / 5</div>
      <div class="pill" id="rewardPill">6-as: -50%</div>
    </div>

    <div class="stamps" id="stamps"></div>

    <hr>

    <div>
      <div class="small"><b>Telefono numeris (neb≈´tina)</b></div>
      <input id="phone" placeholder="+3706xxxxxxx">
      <button class="btn primary" id="savePhone">I≈°saugoti</button>
      <div id="msg" class="small"></div>
    </div>

    <div id="staff" style="display:none;">
      <hr>
      <div class="small"><b>Pardavƒójo re≈æimas</b></div>
      <input id="pin" placeholder="PIN">
      <button class="btn primary" id="add">+ Pridƒóti 1 apsilankymƒÖ</button>
      <div id="staffMsg" class="small"></div>
    </div>

  </div>
</div>

<script>
/* ============================= */
/* ƒÆRA≈†YK SAVO DUOMENIS ƒåIA     */
/* ============================= */

const SUPABASE_URL = "https://omxevzobieebtfuxgrak.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_3c2dqCHnIQVCjPDhWsOwDw_MeHKgJHB";

const FN_GET_OR_CREATE = "https://omxevzobieebtfuxgrak.supabase.co/functions/v1/get_or_create_card";
const FN_ADD_STAMP = "https://omxevzobieebtfuxgrak.supabase.co/functions/v1/add_stamp";

/* ============================= */

const params = new URLSearchParams(location.search);
const SHOP = (params.get("shop") || "geles").toLowerCase();
const SHOP_NAME = params.get("name") || "Gƒólƒós";
const REWARD_TEXT = params.get("reward") || "6-as: -50%";
const TARGET = Number(params.get("target") || 5) || 5;
const STAFF = params.get("staff") === "1";

document.getElementById("title").textContent = SHOP_NAME + " lojalumo kortelƒó üå∏";
document.getElementById("rewardPill").textContent = REWARD_TEXT;

if (STAFF) document.getElementById("staff").style.display = "block";

const stampsEl = document.getElementById("stamps");
const progressEl = document.getElementById("progress");
const subEl = document.getElementById("sub");
const phoneEl = document.getElementById("phone");
const msgEl = document.getElementById("msg");
const staffMsgEl = document.getElementById("staffMsg");

const LS_PHONE_KEY = `loyalty:${SHOP}:phone`;
let cardId = null;

function render(stamps){
  stampsEl.innerHTML = "";
  for(let i=1;i<=TARGET;i++){
    const d = document.createElement("div");
    d.className = "stamp" + (i <= stamps ? " on" : "");
    d.innerText = i <= stamps ? "‚úì" : "";
    stampsEl.appendChild(d);
  }
  progressEl.innerText = stamps + " / " + TARGET;
  subEl.innerText = stamps >= TARGET ? "üéâ Dovana paruo≈°ta!" : "Kaupk apsilankymus ir gauk dovanƒÖ.";
}

async function api(url, body){
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY
    },
    body: JSON.stringify(body)
  });

  const text = await res.text();
  if (!res.ok) throw new Error(res.status + " " + res.statusText + " | " + text);

  try { return JSON.parse(text); }
  catch { throw new Error("Ne JSON atsakymas: " + text); }
}

async function load(phone){
  const data = await api(FN_GET_OR_CREATE,{
    shop: SHOP,
    phone: phone || null,
    target: TARGET,
    reward: REWARD_TEXT
  });

  // jei telefono nƒóra, data.card.id gali b≈´ti null (tavo funkcijoje taip padaryta)
  cardId = data.card.id || null;
  render(Number(data.card.stamps || 0));
}

/* ‚úÖ AUTOMATINIS U≈ΩKROVIMAS KLIENTUI */
(async function init(){
  render(0); // kad visada matyt≈≥ ‚Äúdƒó≈æutes‚Äù
  const savedPhone = (localStorage.getItem(LS_PHONE_KEY) || "").trim();
  if (savedPhone){
    phoneEl.value = savedPhone;
    try{
      await load(savedPhone);
      msgEl.innerHTML = "";
    }catch(e){
      msgEl.innerHTML = "<span class='err'>Klaida: nepavyko u≈ækrauti</span>";
    }
  }
})();

document.getElementById("savePhone").onclick = async () => {
  const phone = phoneEl.value.trim();
  try{
    if (phone) localStorage.setItem(LS_PHONE_KEY, phone);
    await load(phone || null);
    msgEl.innerHTML = "<span class='ok'>I≈°saugota</span>";
  }catch(e){
    msgEl.innerHTML = "<span class='err'>Klaida: " + String(e.message || e) + "</span>";
  }
};

document.getElementById("add").onclick = async () => {
  const pin = document.getElementById("pin").value.trim();

  // Pardavƒójas turi turƒóti kortelƒô (kliento numerƒØ)
  const phone = phoneEl.value.trim();
  if (!phone){
    staffMsgEl.innerHTML = "<span class='err'>ƒÆvesk kliento tel. numerƒØ</span>";
    return;
  }

  try{
    // 1) u≈ætikrinam, kad kortelƒó egzistuoja ir gaunam cardId
    await load(phone);

    if(!cardId){
      staffMsgEl.innerHTML = "<span class='err'>Nepavyko gauti kortelƒós ID</span>";
      return;
    }

    // 2) pridedam ≈°tampƒÖ
    const data = await api(FN_ADD_STAMP,{
      card_id: cardId,
      pin
    });

    render(Number(data.card.stamps || 0));
    staffMsgEl.innerHTML = "<span class='ok'>Pridƒóta</span>";
  }catch(e){
    staffMsgEl.innerHTML = "<span class='err'>Klaida: " + String(e.message || e) + "</span>";
  }
};
</script>
</body>
</html>
